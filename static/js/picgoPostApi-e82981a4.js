var t=Object.defineProperty,e=(e,s,r)=>(((e,s,r)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[s]=r})(e,"symbol"!=typeof s?s+"":s,r),r);import{L as s,v as r,l as a,C as l,au as i,av as o,K as g,a as n,as as h,ao as c,aw as u,at as m,ax as p}from"./AppLayout.vue_vue_type_script_setup_true_lang-59c75e45.js";import{m as d}from"./vendor_blueimp-md5-es6-056b4f91.js";import{E as I}from"./vendor_element-plus-6396cda2.js";class f{constructor(){e(this,"flag"),e(this,"hasImages"),e(this,"mdContent"),e(this,"errmsg")}}class w{constructor(t,s,r,a,l){var i;e(this,"name"),e(this,"hash"),e(this,"originUrl"),e(this,"url"),e(this,"alt"),e(this,"title"),e(this,"isLocal"),this.originUrl=t,this.name=t.substring(t.lastIndexOf("/")+1),this.hash=(i=this.name,d(i)),this.url=s,this.isLocal=r,this.alt=null!=a?a:"",this.title=null!=l?l:""}}class y{constructor(){e(this,"logger",s.getLogger("utils/parser/imageParser.ts"))}hasExternalImages(t){const e=t.match(/!\[.*]\((http|https):\/.*\/.*\)/g);if(null!=e&&e.length>0)return!0;const s=t.match(/!\[.*]\((data:image):\/.*\/.*\)/g);return null!=s&&s.length>0}removeImages(t){let e=t;return e=e.replace(/!\[.*]\((http|https):\/.*\/.*\)/g,""),e}parseImagesToArray(t){let e=[];const s=this.parseRemoteImagesToArray(t),r=this.parseLocalImagesToArray(t);return e=[...new Set([...s,...r])],e}parseRemoteImagesToArray(t){const e=/!\[(.*?)\]\(((https|http|ftp)?:\/\/[^\s/$.?#].[^\s]*)\s*"(.*?)"\)\s*{:\s*([^\n]*)}/g,s=[];for(const r of t.matchAll(e)){const t=r[1]?r[1]:"",e=r[2]?r[2]:"",a=r[3]?r[3].replace(/"/g,""):"";s.push({url:e,alt:t,title:a,isLocal:!1})}return this.logger.debug("远程图片解析完毕."),s}parseLocalImagesToArray(t){const e=/!\[(.*?)\]\(((?!http|https|ftp)assets\/.*?)\s*("(?:.*[^"])")?\)\s*(\{(?:.*[^"])})?/g,s=[];for(const r of t.matchAll(e)){const t=r[1]?r[1]:"",e=r[2]?r[2]:"",a=r[3]?r[3].replace(/"/g,""):"";s.push({url:e,alt:t,title:a,isLocal:!0})}return this.logger.debug("本地图片解析完毕."),s}replaceImagesWithImageItemArray(t,e){var s;let r=t;const a=r.match(/!\[.*]\(assets\/.*\..*\)/g);if(null==a||0===a.length)return this.logger.warn("未匹配到本地图片，将不会替换图片链接"),r;for(let l=0;l<a.length;l++){const t=a[l];this.logger.debug("img=>",t);const i=t.replace(/!\[.*]\(/g,"").replace(/\)/,"");let o,g;this.logger.debug("src=>",i);const n=i.split(" ");n.length>1?(o=n[0],g=n[1].replace(/"/g,"")):o=n[0];const h=e[new w(o,"",!0).hash],c=null!=(s=null==h?void 0:h.alt)?s:"";let u=`![${c}](${null==h?void 0:h.url})`;g&&(u=`![${c}](${null==h?void 0:h.url} "${g}")`),this.logger.debug("newImg=>",u),r=r.replaceAll(t,u)}return r}}class A{constructor(){e(this,"logger",s.getLogger("utils/platform/picgo/picgoPostApi.ts")),e(this,"imageParser"),e(this,"siyuanApi"),this.imageParser=new y,this.siyuanApi=new r}async doConvertImagesToImagesItemArray(t,e){const s=[];for(let r=0;r<e.length;r++){const n=e[r],h=n.url;let c=n.url,u={};if(this.logger.debug("attrs=>",t),a(t[l.PICGO_FILE_MAP_KEY])||(u=i(t[l.PICGO_FILE_MAP_KEY]),this.logger.debug("fileMap=>",u)),n.isLocal){const t=o().baseUrl;c=g(t,"/"+c)}const m=new w(h,c,n.isLocal,n.alt,n.title);if(u[m.hash]){const t=u[m.hash];this.logger.debug("newImageItem=>",t),t.isLocal||(m.isLocal=!1,m.url=t.url)}m.url=decodeURIComponent(m.url),this.logger.debug("imageItem=>",m),s.push(m)}return s}async uploadPostImagesToBed(t,e,s){const r=new f,a=this.imageParser.parseLocalImagesToArray(s),o=[...new Set([...a])];if(this.logger.debug("uniqueLocalImages=>",o),0===o.length)return r.flag=!1,r.hasImages=!1,r.mdContent=s,r.errmsg="文章中没有图片",await Promise.resolve(r);try{r.hasImages=!0;const a=await this.doConvertImagesToImagesItemArray(e,o),g={};let h=!1;for(let s=0;s<a.length;s++){const r=a[s];if(r.originUrl.includes("assets")&&(g[r.hash]=r),!r.isLocal){this.logger.warn("已经上传过图床，请勿重复上传=>",r.originUrl);continue}if(h=!0,n()&&h)throw new Error("检测到有未上传的图片，由于Electron技术限制，挂件通用版不支持上传，仅提供链接替换，请先上传完毕再使用发布。您也可以取消使用图床，或者使用新窗口方式发布。");await this.uploadSingleImageToBed(t,e,r);const o=await this.siyuanApi.getBlockAttrs(t),c=i(o[l.PICGO_FILE_MAP_KEY])[r.hash];g[r.hash]=new w(c.originUrl,c.url,!1,c.alt,c.title)}h||I.warning("未发现本地图片，不上传"),this.logger.debug("准备替换正文图片，replaceMap=>",JSON.stringify(g)),this.logger.debug("开始替换正文，原文=>",JSON.stringify({mdContent:s})),r.mdContent=this.imageParser.replaceImagesWithImageItemArray(s,g),this.logger.debug("图片链接替换完成，新正文=>",JSON.stringify({newmdContent:r.mdContent})),r.flag=!0,this.logger.debug("正文替换完成，最终结果=>",r)}catch(g){r.flag=!1,r.errmsg=g,this.logger.error("文章图片上传失败=>",g)}return await Promise.resolve(r)}async uploadSingleImageToBed(t,e,s,r){var o;const g=null!=(o=e[l.PICGO_FILE_MAP_KEY])?o:"{}",n=i(g);this.logger.warn("fileMap=>",n);const d=[];if(!r&&!s.isLocal)return void this.logger.warn("非本地图片，忽略=>",s.url);let I;if(h){I=`${c()}/assets/${s.name}`,this.logger.info("Will upload picture from",I),u(I)||(I=s.url)}else I=s.url;this.logger.warn("isElectron=>"+h+", imageFullPath=>",I),d.push(I);const f=await m.uploadByPicGO(d);this.logger.warn("图片上传完成，imageJson=>",f);const y=JSON.parse(f);if(!(y&&y.length>0))throw new Error("图片上传失败，可能原因：PicGO配置错误，请检查配置。请打开picgo.log查看更多信息");{const t=y[0];if(!(null==t?void 0:t.imgUrl)||a(t.imgUrl))throw new Error("图片上传失败，可能原因：PicGO配置错误或者该平台不支持图片覆盖，请检查配置或者尝试上传新图片。请打开picgo.log查看更多信息");const e=new w(s.originUrl,t.imgUrl,!1,s.alt,s.title);n[e.hash]=e}this.logger.warn("newFileMap=>",n);const A=p(n);await this.siyuanApi.setBlockAttrs(t,{[l.PICGO_FILE_MAP_KEY]:A})}}export{y as I,A as P,w as a};
