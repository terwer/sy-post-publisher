import{t as e,E as o,h as a,a as t,b as i,M as l,F as s,f as n}from"./vendor_element-plus-6396cda2.js";import{a as c,b as g,ar as d,L as r,as as p,at as m,c as u,v as f,B as h,w,x as y,aj as U}from"./AppLayout.vue_vue_type_script_setup_true_lang-59c75e45.js";import{ad as b,z as C,A as k,O as I,u as L,P,Q as _,a2 as v,X as M,V as S,$ as x,a0 as B,x as V,U as D,_ as T,a1 as $,ao as F,aN as A}from"./vendor-42595716.js";import{u as O}from"./vendor_vue-i18n-8a61efa7.js";import{a as j,P as N,I as E}from"./picgoPostApi-e82981a4.js";const J={class:"picgo-body"},W={class:"upload-status"},z={class:"picgo-opt-btn"},G={class:"file-list"},R=["src","alt"],q=["src"],Q={key:0,class:"log-msg"},X=I({__name:"PicgoIndex",props:{pageId:{type:String,default:void 0}},setup(I){const X=I,H=L(),{picgoCommonData:K,picgoCommonMethods:Y}=(()=>{const e=d.isDev,o=c()||g(),a=b({isUploadLoading:!1,popWidth:400,showDebugMsg:e,loggerMsg:"",isSiyuanOrSiyuanNewWin:o,fileList:{files:[]}});return{picgoCommonData:a,picgoCommonMethods:{getPicgoCommonData:()=>a}}})(),{picgoInitMethods:Z}=((e,o)=>{const a=r.getLogger("composables/picgo/picgoInitPageCom.ts"),t=new f,i=new N,l=new E,s=o.picgoCommonMethods.getPicgoCommonData(),n=async()=>{const o=await u(!0,e.pageId),n=await t.getImageBlocksByID(o);if(a.debug("查询文章中的图片块=>",n),!n||0===n.length)return;let c=[];n.forEach((e=>{const o=l.parseImagesToArray(e.markdown);c=[...new Set([...c,...o])]})),a.debug("解析出来的所有的图片地址=>",c);const g=await t.getBlockAttrs(o),d=await i.doConvertImagesToImagesItemArray(g,c);for(let e=0;e<d.length;e++){const o=d[e];s.fileList.files.push(o)}},c={initPage:async()=>{await n()}};return C((()=>e.pageId),(async()=>{await n(),a.debug("Picgo初始化")})),k((async()=>{await n()})),{picgoInitMethods:c}})(X,{picgoCommonMethods:Y}),{picgoUploadData:ee,picgoUploadMethods:oe}=((a,t,i)=>{const l=r.getLogger("composables/picgo/picgoUploadCom.ts"),{t:s}=O(),n=b({dialogPicgoSettingFormVisible:!1}),d=t.picgoCommonMethods.getPicgoCommonData(),u=i.refSelectedFiles,f=e=>{let a;"string"==typeof e?(l.warn("doAfterUpload返回的是字符串，需要解析"),a=JSON.parse(e)):a=e,d.loggerMsg=JSON.stringify(e),l.debug("doAfterUpload,imgInfos=>",e),a&&a.length>0&&a.forEach((e=>{const o=new j(e.imgUrl,e.imgUrl,!1);d.loggerMsg+="\nnewItem=>"+JSON.stringify(o),d.fileList.files.push(o)})),o.success(s("main.opt.success"))},h={handlePicgoSetting:async()=>{d.showDebugMsg||p?n.dialogPicgoSettingFormVisible=!0:await e.alert(s("picgo.pic.setting.no.tip"),s("main.opt.tip"),{confirmButtonText:s("main.opt.ok")})},bindFileControl:()=>{u.value.click()},doUploadPicSelected:async e=>{d.isUploadLoading=!0;try{const a=e.target.files;if(!a||0===a.length)return o.error("请选择图片"),void(d.isUploadLoading=!1);if(!c()&&!g())return o.error("非electron环境只能通过剪贴板上传"),void(d.isUploadLoading=!1);const t=[];for(let e=0;e<a.length;e++)a.item(e).path?(t.push(a.item(e).path),l.debug("路径不为空")):l.debug("路径为空，忽略");const i=await m.uploadByPicGO(t);f(i),d.isUploadLoading=!1}catch(a){a.toString().indexOf("cancel")<=-1&&(o({type:"error",message:s("main.opt.failure")+"=>"+a}),l.error(s("main.opt.failure")+"=>"+a)),d.isUploadLoading=!1}},doUploadPicFromClipboard:async()=>{d.isUploadLoading=!0;try{const e=await m.uploadByPicGO();f(e),d.isUploadLoading=!1}catch(e){e.toString().indexOf("cancel")<=-1&&(o({type:"error",message:s("main.opt.failure")+"=>"+e}),l.error(s("main.opt.failure")+"=>",e)),d.isUploadLoading=!1}}};return{picgoUploadData:n,picgoUploadMethods:h}})(0,{picgoCommonMethods:Y},{refSelectedFiles:H}),{picgoManageData:ae,picgoManageMethods:te}=((a,t)=>{const i=r.getLogger("composables/picgo/picgoManageCom.ts"),{t:l}=O(),s=new f,n=new N,c=b({dialogImageUrl:"",dialogPreviewVisible:!1}),g=t.picgoCommonMethods.getPicgoCommonData(),d={handleUploadAllImagesToBed:async()=>{g.isUploadLoading=!0;try{let e=!1;const a=g.fileList.files;for(let o=0;o<a.length;o++){const t=a[o];t.isLocal?(e=!0,await d.doUploadImagesToBed(t)):i.warn("已经上传过图床，请勿重复上传=>",t.originUrl)}g.isUploadLoading=!1,e?(o.success("图片已经全部上传至图床，即将刷新页面"),h()):o.warning("未发现本地图片，不上传")}catch(e){g.isUploadLoading=!1,o({type:"error",message:l("main.opt.failure")+"=>"+e}),i.error(l("main.opt.failure")+"=>"+e)}},handleUploadCurrentImageToBed:async a=>{if(g.isUploadLoading=!0,a.isLocal){try{await d.doUploadImagesToBed(a),g.isUploadLoading=!1,o.success("图片已经成功上传至图床，即将刷新页面"),h()}catch(t){g.isUploadLoading=!1,o({type:"error",message:l("main.opt.failure")+"=>"+t}),i.error(l("main.opt.failure")+"=>"+t)}g.isUploadLoading=!1}else e.confirm("已经是远程图片，是否仍然覆盖上传？",l("main.opt.warning"),{confirmButtonText:l("main.opt.ok"),cancelButtonText:l("main.opt.cancel"),type:"warning"}).then((async()=>{try{await d.doUploadImagesToBed(a,!0),g.isUploadLoading=!1,o.success("图片已经成功上传至图床，即将刷新页面"),h()}catch(t){g.isUploadLoading=!1,o({type:"error",message:l("main.opt.failure")+"=>"+t}),i.error(l("main.opt.failure")+"=>"+t)}})).catch((e=>{g.isUploadLoading=!1,e.toString().indexOf("cancel")<=-1&&(o({type:"error",message:l("main.opt.failure")+"，图片上传异常=>"+e}),i.error(l("main.opt.failure")+"=>"+e))}))},doUploadImagesToBed:async(e,o)=>{const t=await u(!0,a.pageId),i=await s.getBlockAttrs(t);await n.uploadSingleImageToBed(t,i,e,o)},onImageUrlCopy:e=>{w()&&y(`![](${e})`)},handlePictureCardPreview:e=>{c.dialogImageUrl=null!=e?e:"",c.dialogPreviewVisible=!0}};return{picgoManageData:c,picgoManageMethods:d}})(X,{picgoCommonMethods:Y,picgoInitMethods:Z});return(e,o)=>{const c=a,g=t,d=A("font-awesome-icon"),r=i,m=l,u=s,f=n;return P(),_("div",J,[v(c,{title:e.$t("setting.picgo.index.tip"),type:"warning",closable:!1},null,8,["title"]),M("div",W,[v(g,{text:"",loading:V(K).isUploadLoading},{default:S((()=>[x(B(e.$t("picgo.upload.status")),1)])),_:1},8,["loading"])]),M("blockquote",z,[M("input",{type:"file",accept:"image/png, image/gif, image/jpeg",onChange:o[0]||(o[0]=(...e)=>V(oe).doUploadPicSelected&&V(oe).doUploadPicSelected(...e)),multiple:"",ref_key:"refSelectedFiles",ref:H},null,544),V(p)?(P(),D(r,{key:0,class:"box-item",effect:"dark",content:e.$t("picgo.upload.select.pic"),placement:"top-start"},{default:S((()=>[v(g,{type:"warning",onClick:V(oe).bindFileControl},{default:S((()=>[v(d,{icon:"fa-solid fa-file-import"})])),_:1},8,["onClick"])])),_:1},8,["content"])):T("",!0),v(r,{class:"box-item",effect:"dark",content:e.$t("picgo.upload.clipboard"),placement:"top-start"},{default:S((()=>[v(g,{type:"primary",onClick:V(oe).doUploadPicFromClipboard},{default:S((()=>[v(d,{icon:"fa-solid fa-paste"})])),_:1},8,["onClick"])])),_:1},8,["content"]),v(r,{class:"box-item",effect:"dark",content:e.$t("picgo.upload.onclick"),placement:"top-start"},{default:S((()=>[v(g,{type:"success",onClick:V(te).handleUploadAllImagesToBed},{default:S((()=>[v(d,{icon:"fa-solid fa-upload"})])),_:1},8,["onClick"])])),_:1},8,["content"]),T("",!0),v(r,{class:"box-item",effect:"dark",content:e.$t("picgo.pic.setting"),placement:"top-start"},{default:S((()=>[v(g,{type:"info",onClick:V(oe).handlePicgoSetting},{default:S((()=>[v(d,{icon:"fa-solid fa-gear"})])),_:1},8,["onClick"])])),_:1},8,["content"])]),M("ul",G,[(P(!0),_($,null,F(V(K).fileList.files,(o=>(P(),_("li",{class:"file-list-item",key:o.name},[M("div",null,[M("img",{src:o.url,alt:o.name},null,8,R)]),M("div",null,[v(r,{content:o.isLocal?e.$t("picgo.download.local.to.bed"):"重新上传",class:"box-item",effect:"dark",placement:"bottom","popper-class":"publish-menu-tooltip"},{default:S((()=>[v(g,{onClick:e=>V(te).handleUploadCurrentImageToBed(o)},{default:S((()=>[v(d,{icon:o.isLocal?"fa-solid fa-upload":"fa-solid fa-arrow-rotate-right"},null,8,["icon"])])),_:2},1032,["onClick"])])),_:2},1032,["content"]),T("",!0),v(m,{placement:"bottom",title:o.alt?o.alt:e.$t("setting.picgo.index.copy.link"),width:V(K).popWidth,trigger:"hover",content:o.url},{reference:S((()=>[v(g,{onClick:e=>V(te).onImageUrlCopy(o.url)},{default:S((()=>[v(d,{icon:"fa-solid fa-file-lines"})])),_:2},1032,["onClick"])])),_:2},1032,["title","width","content"]),v(r,{content:e.$t("picgo.pic.preview"),class:"box-item",effect:"dark",placement:"bottom","popper-class":"publish-menu-tooltip"},{default:S((()=>[v(g,{onClick:e=>V(te).handlePictureCardPreview(o.url)},{default:S((()=>[v(d,{icon:"fa-solid fa-magnifying-glass"})])),_:2},1032,["onClick"])])),_:2},1032,["content"])])])))),128))]),v(u,{modelValue:V(ae).dialogPreviewVisible,"onUpdate:modelValue":o[1]||(o[1]=e=>V(ae).dialogPreviewVisible=e),title:e.$t("picgo.pic.preview")+" - "+V(ae).dialogImageUrl},{default:S((()=>[M("img",{"w-full":"",src:V(ae).dialogImageUrl,alt:"Preview Image",class:"img-big-preview"},null,8,q)])),_:1},8,["modelValue","title"]),v(u,{modelValue:V(ee).dialogPicgoSettingFormVisible,"onUpdate:modelValue":o[2]||(o[2]=e=>V(ee).dialogPicgoSettingFormVisible=e),title:e.$t("picgo.pic.setting")},{default:S((()=>[v(U)])),_:1},8,["modelValue","title"]),V(K).showDebugMsg?(P(),_("div",Q,[v(f,{type:"textarea",autosize:{minRows:5,maxRows:10},modelValue:V(K).loggerMsg,"onUpdate:modelValue":o[3]||(o[3]=e=>V(K).loggerMsg=e)},null,8,["modelValue"])])):T("",!0)])}}});export{X as _};
