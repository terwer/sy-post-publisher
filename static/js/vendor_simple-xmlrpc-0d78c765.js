var e=Object.defineProperty,t=(t,s,n)=>(((t,s,n)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n})(t,"symbol"!=typeof s?s+"":s,n),n);import{s}from"./vendor_sax-d77c0d7b.js";import{f as n}from"./vendor_cross-fetch-e4e57030.js";import{b as a}from"./vendor_byte-base64-0dbd845f.js";import{x as i}from"./vendor_xmlbuilder2-780b1a8c.js";const r=class{constructor(e){var s,n,a;t(this,"_colons",!0),t(this,"_hyphens",!0),t(this,"_ms",!0),null!=e&&(this._colons=null!=(s=e.colons)?s:this._colons,this._hyphens=null!=(n=e.hyphens)?n:this._hyphens,this._ms=null!=(a=e.ms)?a:this._ms)}decodeIso8601(e){var t,s,n,a,i,o;const l=r.ISO8601.exec(e.toString());if(null==l)throw new Error(`Expected a ISO8601 datetime but got "${e}"`);let h=[[l[1],null!=(t=l[3])?t:"01",null!=(s=l[5])?s:"01"].join("-"),"T",[null!=(n=l[7])?n:"00",null!=(a=l[11])?a:"00",null!=(i=l[14])?i:"00"].join(":"),".",null!=(o=l[16])?o:"000"].join("");return h+=null!=l[17]?l[17]+(null!=l[19]&&null==l[20]?"00":""):"Z",new Date(h)}encodeIso8601(e){const t=r.getUTCDateParts(e);return[[t[0],t[1],t[2]].join(this._hyphens?"-":""),"T",[t[3],t[4],t[5]].join(this._colons?":":""),this._ms?"."+t[6]:"","Z"].join("")}static formatCurrentOffset(e){const t=(null!=e?e:new Date).getTimezoneOffset();return 0===t?"Z":[t<0?"+":"-",r.zeroPad(Math.abs(Math.floor(t/60)),2),":",r.zeroPad(Math.abs(t%60),2)].join("")}static zeroPad(e,t){return e.toString().padStart(t,"0")}static getUTCDateParts(e){return[e.getUTCFullYear().toString(),r.zeroPad(e.getUTCMonth()+1,2),r.zeroPad(e.getUTCDate(),2),r.zeroPad(e.getUTCHours(),2),r.zeroPad(e.getUTCMinutes(),2),r.zeroPad(e.getUTCSeconds(),2),r.zeroPad(e.getUTCMilliseconds(),3)]}};let o=r;t(o,"ISO8601",/([0-9]{4})([-]?([0-9]{2}))([-]?([0-9]{2}))(T-?([0-9]{2})(((:?([0-9]{2}))?((:?([0-9]{2}))?(\.([0-9]+))?))?)(Z|([+-]([0-9]{2}(:?([0-9]{2}))?)))?)?/);class l extends Error{constructor(e,s){super("XML-RPC fault"+(null!=e?": "+e:"")),t(this,"code"),t(this,"faultCode"),t(this,"faultString"),this.code=this.faultCode=s,this.faultString=e}}const h=class{constructor(e="utf-8"){t(this,"dateFormatter",new o),t(this,"_type"),t(this,"_responseType"),t(this,"_stack",[]),t(this,"_marks",[]),t(this,"_data",[]),t(this,"_methodname"),t(this,"_encoding"),t(this,"_value",!1),t(this,"_callback",(()=>{})),t(this,"_error"),t(this,"_parser"),t(this,"_onDone",(()=>{var e;if(null==this._error)if(null==this._type||0!==this._marks.length)this._callback(new Error(`Invalid XML-RPC ${null!=(e=this._type)?e:"message"}`));else if("fault"===this._responseType){const e=e=>{const t="string"==typeof e.faultString?e.faultString:void 0,s="number"==typeof e.faultCode?e.faultCode:void 0;return new l(t,s)};this._callback(e(this._stack[0]))}else this._callback(void 0,this._stack)})),t(this,"_onError",(e=>{null==this._error&&(this._error=e,this._callback(this._error))})),t(this,"_push",(e=>{this._stack.push(e)})),t(this,"_onOpentag",(e=>{"ARRAY"!==e.name&&"STRUCT"!==e.name||this._marks.push(this._stack.length),this._data=[],this._value="VALUE"===e.name})),t(this,"_onText",(e=>{this._data.push(e)})),t(this,"_onCDATA",(e=>{this._data.push(e)})),t(this,"_onClosetag",(e=>{const t=this._data.join("");try{switch(e){case"BOOLEAN":this._endBoolean(t);break;case"INT":case"I4":this._endInt(t);break;case"I8":this._endI8(t);break;case"DOUBLE":this._endDouble(t);break;case"STRING":case"NAME":this._endString(t);break;case"ARRAY":this._endArray(t);break;case"STRUCT":this._endStruct(t);break;case"BASE64":this._endBase64(t);break;case"DATETIME.ISO8601":this._endDateTime(t);break;case"VALUE":this._endValue(t);break;case"PARAMS":this._endParams(t);break;case"FAULT":this._endFault(t);break;case"METHODRESPONSE":this._endMethodResponse(t);break;case"METHODNAME":this._endMethodName(t);break;case"METHODCALL":this._endMethodCall(t);break;case"NIL":this._endNil(t);break;case"DATA":case"PARAM":case"MEMBER":case"BR":break;default:this._onError(new Error(`Unknown XML-RPC tag "${e}"`))}}catch(s){this._onError(s)}})),t(this,"_endNil",(e=>{this._push(void 0),this._value=!1})),t(this,"_endBoolean",(e=>{if("1"===e)this._push(!0);else{if("0"!==e)throw new Error("Illegal boolean value '"+e+"'");this._push(!1)}this._value=!1})),t(this,"_endInt",(e=>{const t=parseInt(e,10);if(isNaN(t))throw new Error("Expected an integer but got '"+e+"'");this._push(t),this._value=!1})),t(this,"_endDouble",(e=>{const t=parseFloat(e);if(isNaN(t)){const t=e.toLowerCase();if("nan"===t)this._push(NaN),this._value=!1;else if("-inf"===t||"-infinity"===t)this._push(-1/0),this._value=!1;else{if("inf"!==t&&"infinity"!==t)throw new Error("Expected a double but got '"+e+"'");this._push(1/0),this._value=!1}}else this._push(t),this._value=!1})),t(this,"_endString",(e=>{this._push(e),this._value=!1})),t(this,"_endArray",(e=>{var t;const s=null!=(t=this._marks.pop())?t:0;this._stack.splice(s,this._stack.length-s,this._stack.slice(s)),this._value=!1})),t(this,"_endStruct",(e=>{var t;const s=null!=(t=this._marks.pop())?t:0,n={},a=this._stack.slice(s);for(let i=0;i<a.length;i+=2){n[String(a[i])]=a[i+1]}this._stack.splice(s,this._stack.length-s,n),this._value=!1})),t(this,"_endBase64",(e=>{const t=Buffer.from(e,"base64");this._push(t),this._value=!1})),t(this,"_endDateTime",(e=>{const t=this.dateFormatter.decodeIso8601(e);this._push(t),this._value=!1})),t(this,"_endI8",(e=>{if(!h.isInteger.test(e))throw new Error(`Expected integer (I8) value but got "${e}"`);this._endString(e)})),t(this,"_endValue",(e=>{this._value&&this._endString(e)})),t(this,"_endParams",(e=>{this._responseType="params"})),t(this,"_endFault",(e=>{this._responseType="fault"})),t(this,"_endMethodResponse",(e=>{this._type="methodresponse"})),t(this,"_endMethodName",(e=>{this._methodname=e})),t(this,"_endMethodCall",(e=>{this._type="methodcall"})),this._encoding=e,this._parser=s.createStream(),this._parser.on("opentag",this._onOpentag),this._parser.on("closetag",this._onClosetag),this._parser.on("text",this._onText),this._parser.on("cdata",this._onCDATA),this._parser.on("end",this._onDone),this._parser.on("error",this._onError)}async deserializeMethodResponse(e){return await new Promise(((t,s)=>{this._callback=(e,n)=>{null!=e?s(e):null!=n&&n.length>1?s(new Error("Response has more than one param")):"methodresponse"!==this._type?s(new Error("Not a method response")):null==this._responseType?s(new Error("Invalid method response")):t(null==n?void 0:n[0])},this._parser.end(e,this._encoding)}))}async deserializeMethodCall(e){return await new Promise(((t,s)=>{this._callback=(e,n)=>{null!=e?s(e):"methodcall"!==this._type?s(new Error("Not a method call")):null==this._methodname?s(new Error("Method call did not contain a method name")):t([this._methodname,null!=n?n:[]])},this._parser.end(e,this._encoding)}))}};let u=h;t(u,"isInteger",/^-?\d+$/);class c{constructor(e){t(this,"tagName","customType"),this.raw=e}serialize(e){return e.ele(this.tagName).txt(this.raw)}}const d=/^(?![^<&]*]]>[^<&]*)[^<&]*$/,_=new o;function p(e,t=[],s){const n=i.exports.create({version:"1.0",encoding:s}).ele("methodCall").ele("methodName").txt(e).up().ele("params");return t.forEach((e=>function(e,t){let s={value:e,xml:t};const n=[s];let a,i;for(;n.length>0;)if(s=n[n.length-1],null!=s.index)i=m(s),null!=i?n.push(i):n.pop();else switch(a=s.xml.ele("value"),typeof s.value){case"boolean":f(s.value,a),n.pop();break;case"string":g(s.value,a),n.pop();break;case"number":b(s.value,a),n.pop();break;case"object":null==s.value?(a.ele("nil"),n.pop()):s.value instanceof Date?(v(s.value,a),n.pop()):Buffer.isBuffer(s.value)?(y(s.value,a),n.pop()):s.value instanceof c?(s.value.serialize(a),n.pop()):(Array.isArray(s.value)?s.xml=a.ele("array").ele("data"):(s.xml=a.ele("struct"),s.keys=Object.keys(s.value)),s.index=0,i=m(s),null!=i?n.push(i):n.pop());break;default:n.pop()}}(e,n.ele("param")))),n.doc().toString()}function m(e){let t;if(null!=e.keys&&null!=e.index){if(e.index<e.keys.length){const s=e.keys[e.index++],n=e.xml.ele("member").ele("name").txt(s).up();t={value:e.value[s],xml:n}}}else null!=e.index&&Array.isArray(e.value)&&e.index<e.value.length&&(t={value:e.value[e.index],xml:e.xml},e.index++);return t}function f(e,t){t.ele("boolean").txt(e?"1":"0")}function g(e,t){d.test(e)?t.ele("string").txt(e):t.ele("string").dat(e)}function b(e,t){e%1==0?t.ele("int").txt(String(e)):e===1/0?t.ele("double").txt("inf"):e===-1/0?t.ele("double").txt("-inf"):isNaN(e)?t.ele("double").txt("nan"):t.ele("double").txt(String(e))}function v(e,t){t.ele("dateTime.iso8601").txt(_.encodeIso8601(e))}function y(e,t){t.ele("base64").txt(a(e))}class x{static removeXmlHeader(e){const t=e.indexOf("<?xml");return t>0&&(e=e.substring(t,e.length)),e}}class k{constructor(e,s){t(this,"url"),t(this,"encoding"),t(this,"headers",{"Content-Type":"text/xml",Accept:"text/xml"}),this.url=e,this.encoding=null==s?void 0:s.encoding,null!=(null==s?void 0:s.headers)&&(this.headers={...this.headers,...s.headers})}async methodCall(e,t){const s=p(e,t,this.encoding),a=this.headers;let i;try{i=await n(this.url,{method:"POST",headers:a,body:s});i.url!==this.url&&(i=await n(i.url,{method:"POST",headers:a,body:s}))}catch(l){if("Failed to fetch"===l.message)throw new Error(`XML-RPC call "${e}" to ${this.url} failed to connect`);throw l}if(!i.ok)throw new Error(`XML-RPC call "${e}" to ${this.url} returned ${i.status}: "${i.statusText}"`);let r=await i.text();r=x.removeXmlHeader(r);const o=new u(this.encoding);return await o.deserializeMethodResponse(r)}async multiMethodCall(e){const t=await this.methodCall("system.multicall",[e]);if(!Array.isArray(t)||t.length!==e.length)throw new Error("malformed system.multicall response");const s=[],n=(e={})=>{const t="string"==typeof e.faultString?e.faultString:void 0,s="number"==typeof e.faultCode?e.faultCode:void 0;return new l(t,s)};for(const a of t)Array.isArray(a)&&1===a.length?s.push(a[0]):s.push(n(a));return s}}class w extends k{}export{w as S};
